#!/bin/bash

trap 'exit' ERR

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source "$SCRIPT_DIR/variables"

echo "Deploying ${DIST_NAME} to S3..."

if [[ ! -d $DIST_DIR ]]; then
    echo "Distribution directory does not exist" >&2
    exit 1
fi

cd "$DIST_DIR"  # to avoid "../../../../../dev/shm/..." in the log
aws s3 sync \
    --delete \
    --metadata git-commit="${TRAVIS_COMMIT:0:7}" \
    --no-follow-symlinks \
    --region "$S3_REGION" \
    --size-only  # otherwise all files will be uploaded every time
    --storage-class "$S3_STORAGE_CLASS" \
    . "s3://$S3_BUCKET"
cd "$SCRIPT_DIR"
