#!/bin/bash

trap 'exit' ERR

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source "$SCRIPT_DIR/variables"

echo "Deploying ${DIST_NAME} to S3..."

if [[ ! -d $DIST_DIR ]]; then
    echo "Distribution directory does not exist" >&2
    exit 1
fi

cd "$DIST_DIR"  # to avoid "../../../../../dev/shm/..." in the log
# TODO do not depend on sizes being different - make timestamps work.
#      can you do a diff with the old live code and upload the changes?
aws s3 sync \
    --delete \
    --metadata git-commit="${TRAVIS_COMMIT:0:7}" \
    --no-follow-symlinks \
    --region "$S3_REGION" \
    --size-only  # otherwise all files will be uploaded every time
    --storage-class "$S3_STORAGE_CLASS" \
    . "s3://$S3_BUCKET"
cd "$SCRIPT_DIR"

# TODO only invalidate changed files (related to TODO above) (#3)
aws configure set preview.cloudfront true
aws cloudfront create-invalidation \
    --distribution-id "$CLOUDFRONT_DISTRIBUTION" \
    --paths "/*"

# TODO flush Cloudflare's cache if necessary (#3)
